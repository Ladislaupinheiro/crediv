<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Clientes Devedores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen pb-20">

    <!-- Header -->
    <header class="bg-blue-700 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold italic">Bebidas Dívidas</h1>
            <div id="total-geral-header" class="text-right">
                <p class="text-xs opacity-80">Total em Falta</p>
                <p class="font-bold text-lg" id="valor-global">0,00 Kz</p>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-4">
        
        <!-- Search & Filter -->
        <div class="relative">
            <input type="text" id="search-input" placeholder="Pesquisar cliente..." 
                class="w-full p-3 pl-10 rounded-xl border-none shadow-sm focus:ring-2 focus:ring-blue-500 bg-white">
            <span class="absolute left-3 top-3.5 opacity-40">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </span>
        </div>

        <!-- Dashboard Stats -->
        <div class="grid grid-cols-2 gap-4">
            <button onclick="exportarRelatorioGeral()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center">
                <span class="text-blue-600 mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                </span>
                <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">Relatório Geral</span>
            </button>
            <div class="bg-blue-50 p-3 rounded-xl shadow-sm border border-blue-100 flex flex-col items-center">
                <span class="text-blue-700 text-lg font-bold" id="total-clientes-count">0</span>
                <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">Devedores</span>
            </div>
        </div>

        <!-- Client List -->
        <div id="lista-clientes" class="space-y-3">
            <!-- Rendered by JS -->
        </div>

    </main>

    <!-- Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-around safe-bottom z-50">
        <button onclick="toggleView('lista')" class="flex flex-col items-center text-blue-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            <span class="text-[10px] mt-1 font-medium">Clientes</span>
        </button>
        <button onclick="abrirModalCliente()" class="bg-blue-600 text-white p-4 rounded-full -mt-10 shadow-lg border-4 border-gray-50">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        </button>
        <button onclick="toggleView('config')" class="flex flex-col items-center text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            <span class="text-[10px] mt-1 font-medium">Sobre</span>
        </button>
    </nav>

    <!-- Modal Novo Cliente -->
    <div id="modal-cliente" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] p-4 flex items-center justify-center">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl animate-scale-in">
            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                <h3 class="font-bold">Novo Cliente</h3>
                <button onclick="fecharModalCliente()" class="text-gray-400">&times;</button>
            </div>
            <div class="p-4 space-y-4">
                <div class="flex flex-col items-center">
                    <label class="cursor-pointer">
                        <div id="foto-preview" class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-300">
                            <span class="text-xs text-gray-500">Adicionar Foto</span>
                        </div>
                        <input type="file" id="foto-input" accept="image/*" class="hidden" onchange="handleFotoUpload(event)">
                    </label>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Nome Completo</label>
                    <input type="text" id="nome-cliente" class="w-full p-2 border rounded-lg bg-gray-50" placeholder="Ex: João Silva">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Contacto / Telefone</label>
                    <input type="tel" id="telefone-cliente" class="w-full p-2 border rounded-lg bg-gray-50" placeholder="Ex: 923...">
                </div>
                <button onclick="salvarCliente()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">CRIAR PERFIL</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes do Cliente -->
    <div id="modal-detalhes" class="fixed inset-0 bg-white hidden z-[70] overflow-y-auto">
        <div class="bg-blue-700 p-6 pb-20 relative">
            <button onclick="fecharModalDetalhes()" class="absolute top-6 left-4 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <div class="flex flex-col items-center mt-6">
                <div id="detalhe-foto" class="w-28 h-28 rounded-full border-4 border-white shadow-xl bg-gray-100 overflow-hidden"></div>
                <h2 id="detalhe-nome" class="text-white text-2xl font-bold mt-4">Nome do Cliente</h2>
                <p id="detalhe-telefone" class="text-blue-100 opacity-80">9xx xxx xxx</p>
                <div class="bg-white/20 backdrop-blur-md rounded-2xl p-4 mt-6 w-full text-center">
                    <p class="text-xs text-blue-100 uppercase tracking-widest font-bold">Dívida Atual</p>
                    <p id="detalhe-total" class="text-3xl font-black text-white">0,00 Kz</p>
                </div>
            </div>
        </div>

        <div class="bg-white -mt-10 rounded-t-3xl p-6 min-h-[60vh] relative z-10 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg">Histórico de Movimentos</h3>
                <div class="flex gap-2">
                    <button onclick="exportarRelatorioCliente()" class="p-2 bg-gray-100 rounded-lg text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    </button>
                    <button onclick="adicionarDivida()" class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold text-sm">+ Dívida</button>
                </div>
            </div>

            <div id="historico-lista" class="space-y-4">
                <!-- Records by JS -->
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Movimento -->
    <div id="modal-movimento" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[80] p-4 flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-2xl overflow-hidden p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4" id="movimento-titulo">Registar Dívida</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Descrição da Bebida/Item</label>
                    <input type="text" id="mov-desc" class="w-full p-3 border rounded-xl bg-gray-50" placeholder="Ex: Cuca 1L, Whisky...">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Valor (Kz)</label>
                    <input type="number" id="mov-valor" class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-lg" placeholder="0">
                </div>
                <div class="flex gap-2">
                    <button onclick="fecharModalMovimento()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">Cancelar</button>
                    <button onclick="confirmarMovimento()" class="flex-[2] py-3 bg-blue-600 text-white rounded-xl font-bold">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data State
        let clientes = JSON.parse(localStorage.getItem('db_bebidas_clientes')) || [];
        let currentClienteIndex = null;
        let currentPhoto = null;

        const { jsPDF } = window.jspdf;

        // --- Core Functions ---

        function renderClientes(filtro = '') {
            const container = document.getElementById('lista-clientes');
            container.innerHTML = '';
            
            const listagem = clientes.filter(c => c.nome.toLowerCase().includes(filtro.toLowerCase()));
            
            document.getElementById('total-clientes-count').innerText = listagem.length;
            let totalGlobal = 0;

            listagem.forEach((cliente, index) => {
                const dividaTotal = cliente.historico.reduce((acc, mov) => acc + (mov.tipo === 'divida' ? mov.valor : -mov.valor), 0);
                totalGlobal += dividaTotal;

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between active:scale-95 transition-transform cursor-pointer";
                card.onclick = () => verDetalhes(clientes.indexOf(cliente));
                
                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-blue-100 overflow-hidden">
                            ${cliente.foto ? `<img src="${cliente.foto}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-blue-500 font-bold">${cliente.nome[0]}</div>`}
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800">${cliente.nome}</h4>
                            <p class="text-xs text-gray-400">${cliente.telefone || 'Sem contacto'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold text-gray-400 uppercase">Dívida</p>
                        <p class="font-bold ${dividaTotal > 0 ? 'text-red-500' : 'text-green-500'}">${formatarKz(dividaTotal)}</p>
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('valor-global').innerText = formatarKz(totalGlobal);
        }

        function formatarKz(valor) {
            return valor.toLocaleString('pt-AO', { style: 'currency', currency: 'AOA' }).replace('AOA', 'Kz');
        }

        function toggleView(view) {
            if(view === 'config') {
                alert("Gestor de Dívidas v1.0\nCriado para o mercado Angolano.\nPermite exportar PDFs e gerir saldos em Kwanza.");
            }
        }

        // --- Modal & Form Actions ---

        function abrirModalCliente() {
            document.getElementById('modal-cliente').classList.remove('hidden');
        }

        function fecharModalCliente() {
            document.getElementById('modal-cliente').classList.add('hidden');
            limparFormCliente();
        }

        function handleFotoUpload(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                currentPhoto = event.target.result;
                document.getElementById('foto-preview').innerHTML = `<img src="${currentPhoto}" class="w-full h-full object-cover">`;
            }
            reader.readAsDataURL(e.target.files[0]);
        }

        function salvarCliente() {
            const nome = document.getElementById('nome-cliente').value;
            const telefone = document.getElementById('telefone-cliente').value;

            if(!nome) return alert("O nome é obrigatório!");

            clientes.push({
                nome,
                telefone,
                foto: currentPhoto,
                historico: [],
                dataCriacao: new Date().toISOString()
            });

            syncStorage();
            fecharModalCliente();
            renderClientes();
        }

        function verDetalhes(index) {
            currentClienteIndex = index;
            const cliente = clientes[index];
            
            document.getElementById('detalhe-nome').innerText = cliente.nome;
            document.getElementById('detalhe-telefone').innerText = cliente.telefone || 'Sem telefone';
            document.getElementById('detalhe-foto').innerHTML = cliente.foto ? `<img src="${cliente.foto}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-blue-300 text-3xl font-bold">${cliente.nome[0]}</div>`;
            
            atualizarListaHistorico();
            document.getElementById('modal-detalhes').classList.remove('hidden');
        }

        function atualizarListaHistorico() {
            const cliente = clientes[currentClienteIndex];
            const lista = document.getElementById('historico-lista');
            lista.innerHTML = '';

            const total = cliente.historico.reduce((acc, mov) => acc + (mov.tipo === 'divida' ? mov.valor : -mov.valor), 0);
            document.getElementById('detalhe-total').innerText = formatarKz(total);

            if(cliente.historico.length === 0) {
                lista.innerHTML = `<div class="text-center py-10 text-gray-400 text-sm italic">Este cliente não tem histórico de dívidas.</div>`;
                return;
            }

            cliente.historico.sort((a,b) => new Date(b.data) - new Date(a.data)).forEach((mov, idx) => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center border-b border-gray-50 pb-3";
                item.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-700">${mov.descricao}</p>
                        <p class="text-[10px] text-gray-400">${new Date(mov.data).toLocaleDateString()} às ${new Date(mov.data).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <p class="font-bold text-red-500">+ ${formatarKz(mov.valor)}</p>
                        <button onclick="eliminarMovimento(${idx})" class="text-gray-200">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                        </button>
                    </div>
                `;
                lista.appendChild(item);
            });
        }

        function adicionarDivida() {
            document.getElementById('mov-valor').value = "";
            document.getElementById('mov-desc').value = "";
            document.getElementById('modal-movimento').classList.remove('hidden');
        }

        function fecharModalMovimento() {
            document.getElementById('modal-movimento').classList.add('hidden');
        }

        function confirmarMovimento() {
            const desc = document.getElementById('mov-desc').value;
            const valor = parseFloat(document.getElementById('mov-valor').value);

            if(!desc || isNaN(valor)) return alert("Preencha a descrição e o valor!");

            clientes[currentClienteIndex].historico.push({
                tipo: 'divida',
                descricao: desc,
                valor: valor,
                data: new Date().toISOString()
            });

            syncStorage();
            atualizarListaHistorico();
            renderClientes();
            fecharModalMovimento();
        }

        function fecharModalDetalhes() {
            document.getElementById('modal-detalhes').classList.add('hidden');
        }

        function syncStorage() {
            localStorage.setItem('db_bebidas_clientes', JSON.stringify(clientes));
        }

        function limparFormCliente() {
            document.getElementById('nome-cliente').value = "";
            document.getElementById('telefone-cliente').value = "";
            document.getElementById('foto-preview').innerHTML = `<span class="text-xs text-gray-500">Adicionar Foto</span>`;
            currentPhoto = null;
        }

        // --- Search Functionality ---
        document.getElementById('search-input').addEventListener('input', (e) => {
            renderClientes(e.target.value);
        });

        // --- PDF Reporting ---

        function exportarRelatorioCliente() {
            const cliente = clientes[currentClienteIndex];
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.setTextColor(25, 118, 210);
            doc.text("Relatório de Dívida", 14, 22);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Cliente: ${cliente.nome}`, 14, 35);
            doc.text(`Contacto: ${cliente.telefone || 'N/A'}`, 14, 42);
            doc.text(`Data: ${new Date().toLocaleDateString()}`, 14, 49);

            const items = cliente.historico.map(m => [
                new Date(m.data).toLocaleDateString(),
                m.descricao,
                formatarKz(m.valor)
            ]);

            const total = cliente.historico.reduce((acc, m) => acc + m.valor, 0);

            doc.autoTable({
                startY: 60,
                head: [['Data', 'Descrição', 'Valor']],
                body: items,
                foot: [['', 'TOTAL ACUMULADO', formatarKz(total)]]
            });

            doc.save(`relatorio_${cliente.nome.replace(/\s+/g, '_')}.pdf`);
        }

        function exportarRelatorioGeral() {
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.text("Mapa Geral de Devedores", 14, 22);
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 30);

            let globalSum = 0;
            const tableData = clientes.map(c => {
                const soma = c.historico.reduce((acc, m) => acc + m.valor, 0);
                globalSum += soma;
                return [c.nome, c.telefone || '-', formatarKz(soma)];
            });

            doc.autoTable({
                startY: 40,
                head: [['Cliente', 'Contacto', 'Saldo em Dívida']],
                body: tableData,
                foot: [['TOTAL GERAL', '', formatarKz(globalSum)]]
            });

            doc.save("relatorio_geral_bebidas.pdf");
        }

        function eliminarMovimento(idx) {
            if(confirm("Deseja apagar este registo?")) {
                clientes[currentClienteIndex].historico.splice(idx, 1);
                syncStorage();
                atualizarListaHistorico();
                renderClientes();
            }
        }

        // Initialize
        window.onload = () => renderClientes();

    </script>
</body>
</html>